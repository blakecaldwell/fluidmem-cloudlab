From f637646c1c53c9328c8834e8b27fcd67d9a29f27 Mon Sep 17 00:00:00 2001
From: Blake Caldwell <caldweba@colorado.edu>
Date: Wed, 19 Aug 2015 22:50:57 -0600
Subject: [PATCH 2/4] Remove references to IBV_QPT_RAW_ETH which was removed in
 current versions of libiberbs from openfabrics.org and Ubuntu

Signed-off-by: Blake Caldwell <caldweba@colorado.edu>
---
 src/InfUdDriver.cc |  5 +++--
 src/Infiniband.cc  | 15 ++++++++-------
 2 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/src/InfUdDriver.cc b/src/InfUdDriver.cc
index a9d027f..438e250 100644
--- a/src/InfUdDriver.cc
+++ b/src/InfUdDriver.cc
@@ -128,8 +128,9 @@ InfUdDriver::InfUdDriver(Context* context,
         throw DriverException(HERE, errno);
     }
 
-    qp = infiniband->createQueuePair(localMac ? IBV_QPT_RAW_ETH
-                                              : IBV_QPT_UD,
+//    qp = infiniband->createQueuePair(localMac ? IBV_QPT_RAW_ETH
+//                                              : IBV_QPT_UD,
+    qp = infiniband->createQueuePair(IBV_QPT_UD,
                                      ibPhysicalPort, NULL,
                                      txcq, rxcq, MAX_TX_QUEUE_DEPTH,
                                      MAX_RX_QUEUE_DEPTH,
diff --git a/src/Infiniband.cc b/src/Infiniband.cc
index 3a98fae..801dfee 100644
--- a/src/Infiniband.cc
+++ b/src/Infiniband.cc
@@ -518,7 +518,8 @@ Infiniband::QueuePair::QueuePair(Infiniband& infiniband, ibv_qp_type type,
       peerLid(0)
 {
     snprintf(peerName, sizeof(peerName), "?unknown?");
-    if (type != IBV_QPT_RC && type != IBV_QPT_UD && type != IBV_QPT_RAW_ETH)
+    //if (type != IBV_QPT_RC && type != IBV_QPT_UD && type != IBV_QPT_RAW_ETH)
+    if (type != IBV_QPT_RC && type != IBV_QPT_UD)
         throw TransportException(HERE, "invalid queue pair type");
 
     ibv_qp_init_attr qpia;
@@ -562,8 +563,6 @@ Infiniband::QueuePair::QueuePair(Infiniband& infiniband, ibv_qp_type type,
         mask |= IBV_QP_QKEY;
         mask |= IBV_QP_PKEY_INDEX;
         break;
-    case IBV_QPT_RAW_ETH:
-        break;
     default:
         assert(0);
     }
@@ -680,7 +679,8 @@ void
 Infiniband::QueuePair::activate(const Tub<MacAddress>& localMac)
 {
     ibv_qp_attr qpa;
-    if (type != IBV_QPT_UD && type != IBV_QPT_RAW_ETH)
+//    if (type != IBV_QPT_UD && type != IBV_QPT_RAW_ETH)
+    if (type != IBV_QPT_UD)
         throw TransportException(HERE, "activate() called on wrong qp type");
 
     if (getState() != IBV_QPS_INIT) {
@@ -701,17 +701,17 @@ Infiniband::QueuePair::activate(const Tub<MacAddress>& localMac)
     // now move to RTS state
     qpa.qp_state = IBV_QPS_RTS;
     int flags = IBV_QP_STATE;
-    if (type != IBV_QPT_RAW_ETH) {
+//    if (type != IBV_QPT_RAW_ETH) {
         qpa.sq_psn = initialPsn;
         flags |= IBV_QP_SQ_PSN;
-    }
+//    }
     ret = ibv_modify_qp(qp, &qpa, flags);
     if (ret) {
         LOG(ERROR, "failed to transition to RTS state");
         throw TransportException(HERE, ret);
     }
 
-    if (type == IBV_QPT_RAW_ETH) {
+/*    if (type == IBV_QPT_RAW_ETH) {
         ibv_gid mgid;
         memset(&mgid, 0, sizeof(mgid));
         memcpy(&mgid.raw[10], localMac->address, 6);
@@ -720,6 +720,7 @@ Infiniband::QueuePair::activate(const Tub<MacAddress>& localMac)
             throw TransportException(HERE, ret);
         }
     }
+*/
 }
 
 /**
-- 
2.1.4

